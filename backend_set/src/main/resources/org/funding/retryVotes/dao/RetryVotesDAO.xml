<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.funding.retryVotes.dao.RetryVotesDAO">

    <!-- 투표 삽입 -->
    <insert id="addRetryVotes" parameterType="org.funding.retryVotes.dto.DoVoteRequestDTO">
        INSERT INTO retry_votes (user_id, funding_id)
        VALUES (#{userId}, #{fundingId})
    </insert>

    <!-- 펀딩별 투표 수 -->
    <select id="countRetryVotesByFundingId" resultType="int" parameterType="long">
        SELECT COUNT(*) FROM retry_votes WHERE funding_id = #{fundingId}
    </select>

    <!-- 유저가 이미 투표했는지 확인 -->
    <select id="existsVoteByUserIdAndFundingId" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM retry_votes WHERE user_id = #{userId} AND funding_id = #{fundingId}
        )
    </select>

<!--    투표 취소-->
    <delete id="deleteRetryVotes" parameterType="org.funding.retryVotes.dto.DoVoteRequestDTO">
        DELETE FROM funding_vote
        WHERE user_id = #{userId}
          AND funding_id = #{fundingId}
    </delete>


<!--    내가 투표한 펀딩 조회-->
    <select id="findVotedFundDetailsByUserId" resultType="org.funding.retryVotes.dto.MyVotedFundDTO">
        SELECT
            f.fund_id AS fundId,
            p.name AS productName,
            f.progress AS progress,
            f.end_at AS endAt,
            (SELECT image_url FROM s3_image
             WHERE post_id = p.product_id
               AND image_type = 'Funding'
             ORDER BY created_at ASC
                LIMIT 1) AS productImageUrl
        FROM
            retry_votes rv
            JOIN
            fund f ON rv.funding_id = f.fund_id
            JOIN
            financial_product p ON f.product_id = p.product_id
        WHERE
            rv.user_id = #{userId}
        ORDER BY
            rv.retry_id DESC
    </select>
</mapper>
