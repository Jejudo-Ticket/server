<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.funding.fund.dao.FundDAO">

    <!-- 펀딩 정보 resultMap -->
    <resultMap id="fundVOResultMap" type="org.funding.fund.vo.FundVO">
        <id property="fundId" column="fund_id" />
        <result property="productId" column="product_id" />
        <result property="projectId" column="project_id" />
        <result property="progress" column="progress" javaType="org.funding.fund.vo.enumType.ProgressType" />
        <result property="launchAt" column="launch_at" />
        <result property="endAt" column="end_at" />
        <result property="financialInstitution" column="financial_institution" />
    </resultMap>

    <!-- 펀딩 생성 -->
    <insert id="insert" parameterType="org.funding.fund.vo.FundVO" useGeneratedKeys="true" keyProperty="fundId">
        INSERT INTO fund_db.fund (
            product_id, project_id, progress, launch_at, end_at, financial_institution
        ) VALUES (
            #{productId}, #{projectId}, #{progress}, #{launchAt}, #{endAt}, #{financialInstitution}
        )
    </insert>

    <!-- 펀딩 조회 by ID -->
    <select id="selectById" parameterType="long" resultMap="fundVOResultMap">
        SELECT 
            fund_id, product_id, project_id, progress, launch_at, end_at, financial_institution
        FROM fund_db.fund
        WHERE fund_id = #{fundId}
    </select>

    <!-- 프로젝트 ID로 펀딩 목록 조회 -->
    <select id="selectByProjectId" parameterType="long" resultMap="fundVOResultMap">
        SELECT 
            fund_id, product_id, project_id, progress, launch_at, end_at, financial_institution
        FROM fund_db.fund
        WHERE project_id = #{projectId}
        ORDER BY fund_id DESC
    </select>

    <!-- 상품 ID로 펀딩 목록 조회 -->
    <select id="selectByProductId" parameterType="long" resultMap="fundVOResultMap">
        SELECT 
            fund_id, product_id, project_id, progress, launch_at, end_at, financial_institution
        FROM fund_db.fund
        WHERE product_id = #{productId}
        ORDER BY fund_id DESC
    </select>


    <!-- 펀딩 업데이트 -->
    <update id="update" parameterType="org.funding.fund.vo.FundVO">
        UPDATE fund_db.fund
        SET 
            progress = #{progress},
            launch_at = #{launchAt},
            end_at = #{endAt},
            financial_institution = #{financialInstitution}
        WHERE fund_id = #{fundId}
    </update>

    <!-- 펀딩 상태 업데이트 -->
    <update id="updateProgress" parameterType="map">
        UPDATE fund_db.fund
        SET progress = #{progress}
        WHERE fund_id = #{fundId}
    </update>

    <!-- 펀딩 삭제 -->
    <delete id="delete" parameterType="long">
        DELETE FROM fund_db.fund
        WHERE fund_id = #{fundId}
    </delete>

    <!-- 모든 펀딩 조회 -->
    <select id="selectAll" resultMap="fundVOResultMap">
        SELECT 
            fund_id, product_id, project_id, progress, launch_at, end_at, financial_institution
        FROM fund_db.fund
        ORDER BY fund_id DESC
    </select>

    <!-- 펀딩 통계 조회 -->
    <select id="countByProgress" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM fund_db.fund
        WHERE progress = #{progress}
    </select>

    <!-- 진행상태 + 펀드타입별 펀딩 목록 조회 -->
    <select id="selectByProgressAndFundType" resultType="org.funding.fund.dto.FundListResponseDTO">
        SELECT 
            f.fund_id as fundId, 
            f.product_id as productId, 
            f.project_id as projectId, 
            f.progress as progress, 
            f.launch_at as launchAt, 
            f.end_at as endAt, 
            f.financial_institution as financialInstitution,
            fp.name as name,
            fp.icon_url as thumbnail,
            fp.fund_type as fundType
        FROM fund_db.fund f
        INNER JOIN fund_db.financialproduct fp ON f.product_id = fp.product_id
        WHERE f.progress = #{progress}
        <if test="fundType != null">
            AND fp.fund_type = #{fundType}
        </if>
        ORDER BY f.fund_id DESC
    </select>


</mapper>